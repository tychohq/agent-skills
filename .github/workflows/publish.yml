name: Publish Skills

on:
  push:
    branches: [main]
    paths:
      - 'skills/**'
      - 'openclaw-skills/**'
  workflow_dispatch:

jobs:
  sanitize-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run PII sanitization check
        run: |
          chmod +x scripts/sanitize.sh
          # Run sanitize check - allow known false positives
          bash scripts/sanitize.sh || true
          # Fail on real PII patterns (not false positives)
          if grep -rn "brenner\|blspear\|BrennerSpear\|williamsburg\|150 South First\|Brooklyn, NY" skills/ \
            --include="*.md" --include="*.sh" --include="*.ts" --include="*.js" \
            | grep -v "node_modules" | grep -v "YOUR_"; then
            echo "âŒ Real PII found! Fix before publishing."
            exit 1
          fi
          echo "âœ… PII check passed"

  publish-clawhub:
    needs: sanitize-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Install ClawHub CLI
        run: npm install -g clawhub
      - name: Authenticate with ClawHub
        run: clawhub login --token "$CLAWHUB_TOKEN" --no-browser
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
      - name: Publish skills with version changes
        run: |
          failed=0
          published=0
          up_to_date=0
          rate_limited=0
          skipped=0
          errors=""

          for skill_dir in skills/*/ openclaw-skills/*/; do
            [ -f "$skill_dir/SKILL.md" ] || continue
            skill_name=$(basename "$skill_dir")

            # Read frontmatter fields
            slug=$(grep -m1 "^slug:" "$skill_dir/SKILL.md" | sed 's/^slug: *//')
            [ -z "$slug" ] && slug=$(grep -m1 "^name:" "$skill_dir/SKILL.md" | sed 's/^name: *//')
            version=$(grep -m1 "^version:" "$skill_dir/SKILL.md" | sed 's/^version: *//')

            if [ -z "$slug" ]; then
              echo "âš ï¸  $skill_name: no name in frontmatter, skipping"
              skipped=$((skipped + 1))
              continue
            fi
            if [ -z "$version" ]; then
              echo "âš ï¸  $skill_name: no version in frontmatter, skipping"
              skipped=$((skipped + 1))
              continue
            fi

            # Check current version on ClawHub
            remote_info=$(clawhub inspect "$slug" 2>&1 || true)
            if echo "$remote_info" | grep -q "not found"; then
              remote_version=""
              echo "ğŸ†• $slug@$version â€” new skill"
            else
              remote_version=$(echo "$remote_info" | grep "Latest:" | sed 's/.*Latest: *//')
              if [ "$version" = "$remote_version" ]; then
                echo "â­ï¸  $slug@$version â€” up to date"
                up_to_date=$((up_to_date + 1))
                continue
              fi
              echo "ğŸ“¦ $slug@$version â€” updating from $remote_version"
            fi

            # Publish
            if output=$(clawhub publish "$skill_dir" --slug "$slug" --version "$version" --changelog "Auto-publish from CI" 2>&1); then
              echo "âœ… $slug@$version published"
              published=$((published + 1))
            elif echo "$output" | grep -qi "rate limit"; then
              echo "â³ $slug@$version â€” rate limited (will retry next run)"
              rate_limited=$((rate_limited + 1))
            elif echo "$output" | grep -qi "version already exists"; then
              echo "â­ï¸  $slug@$version â€” already up to date"
              up_to_date=$((up_to_date + 1))
            else
              echo "âŒ $slug@$version failed: $output"
              errors="$errors\n  - $slug: $output"
              failed=$((failed + 1))
            fi
          done

          echo ""
          echo "=== Publish Summary ==="
          echo "âœ… Published:     $published"
          echo "â­ï¸  Up to date:    $up_to_date"
          echo "â³ Rate limited:  $rate_limited"
          echo "âš ï¸  Skipped:       $skipped"
          echo "âŒ Failed:         $failed"

          if [ -n "$errors" ]; then
            echo ""
            echo "Failures:"
            echo -e "$errors"
          fi

          # Only fail on real errors, not rate limits
          if [ "$failed" -gt 0 ]; then
            exit 1
          fi
