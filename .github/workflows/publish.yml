name: Publish Skills

on:
  push:
    branches: [main]
    paths:
      - 'skills/**'
      - 'openclaw-skills/**'
  workflow_dispatch:

jobs:
  sanitize-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run PII sanitization check
        run: |
          chmod +x scripts/sanitize.sh
          # Run sanitize check - allow known false positives
          bash scripts/sanitize.sh || true
          # Fail on real PII patterns (not false positives)
          if grep -rn "brenner\|blspear\|BrennerSpear\|williamsburg\|150 South First\|Brooklyn, NY" skills/ \
            --include="*.md" --include="*.sh" --include="*.ts" --include="*.js" \
            | grep -v "node_modules" | grep -v "YOUR_"; then
            echo "‚ùå Real PII found! Fix before publishing."
            exit 1
          fi
          echo "‚úÖ PII check passed"

  publish-clawhub:
    needs: sanitize-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Find changed skills
        id: changed
        run: |
          # Get skill dirs with changes in this push
          changed_dirs=$(git diff --name-only HEAD~1 HEAD -- 'skills/' 'openclaw-skills/' \
            | grep -oE '^(skills|openclaw-skills)/[^/]+' \
            | sort -u)

          if [ -z "$changed_dirs" ]; then
            # workflow_dispatch: publish all
            changed_dirs=$(find skills openclaw-skills -mindepth 1 -maxdepth 1 -type d 2>/dev/null | sort)
          fi

          echo "Changed skill dirs:"
          echo "$changed_dirs"
          # Pass as multiline output
          {
            echo "dirs<<EOF"
            echo "$changed_dirs"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Install ClawHub CLI
        if: steps.changed.outputs.dirs != ''
        run: npm install -g clawhub
      - name: Authenticate with ClawHub
        if: steps.changed.outputs.dirs != ''
        run: clawhub login --token "$CLAWHUB_TOKEN" --no-browser
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
      - name: Publish changed skills
        if: steps.changed.outputs.dirs != ''
        run: |
          failed=0
          succeeded=0
          skipped=0
          up_to_date=0
          errors=""

          while IFS= read -r skill_dir; do
            [ -z "$skill_dir" ] && continue
            [ -f "$skill_dir/SKILL.md" ] || continue
            skill_name=$(basename "$skill_dir")

            slug=$(grep -m1 "^name:" "$skill_dir/SKILL.md" | sed 's/^name: *//')
            version=$(grep -m1 "^version:" "$skill_dir/SKILL.md" | sed 's/^version: *//')

            if [ -z "$slug" ]; then
              echo "‚ö†Ô∏è  $skill_name: no name in frontmatter, skipping"
              skipped=$((skipped + 1))
              continue
            fi
            if [ -z "$version" ]; then
              echo "‚ö†Ô∏è  $skill_name: no version in frontmatter, skipping"
              skipped=$((skipped + 1))
              continue
            fi

            echo "üì¶ Publishing $slug@$version from $skill_dir..."
            if output=$(clawhub publish "$skill_dir" --slug "$slug" --version "$version" --changelog "Auto-publish from CI" 2>&1); then
              echo "‚úÖ $slug@$version published"
              succeeded=$((succeeded + 1))
            elif echo "$output" | grep -qi "version already exists"; then
              echo "‚è≠Ô∏è  $slug@$version already up to date"
              up_to_date=$((up_to_date + 1))
            else
              echo "‚ùå $slug@$version failed: $output"
              errors="$errors\n  - $slug: $output"
              failed=$((failed + 1))
            fi
          done <<< "${{ steps.changed.outputs.dirs }}"

          echo ""
          echo "=== Publish Summary ==="
          echo "‚úÖ Published:    $succeeded"
          echo "‚è≠Ô∏è  Up to date:   $up_to_date"
          echo "‚ö†Ô∏è  Skipped:      $skipped"
          echo "‚ùå Failed:        $failed"

          if [ -n "$errors" ]; then
            echo ""
            echo "Failures:"
            echo -e "$errors"
          fi

          if [ "$failed" -gt 0 ]; then
            exit 1
          fi
