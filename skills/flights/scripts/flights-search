#!/usr/bin/env python3
"""Search flights via Google Flights using the fast-flights library.

Supports city names (NYC, London, Tokyo) that auto-expand to all nearby airports.
"""

import argparse
import sys

# Metro area → associated names (cities, IATA codes, neighborhoods, airport names)
# Derived from knowhere/src/utils/metro-areas.ts
METRO_AREAS = {
    "New York": {
        "aliases": [
            "new york", "nyc", "manhattan", "brooklyn", "queens",
            "bronx", "the bronx", "staten island", "newark",
            "laguardia", "la guardia",
        ],
        "airports": ["JFK", "EWR", "LGA"],
    },
    "San Francisco Bay Area": {
        "aliases": [
            "san francisco", "sf", "bay area", "oakland", "san jose",
        ],
        "airports": ["SFO", "OAK", "SJC"],
    },
    "Los Angeles": {
        "aliases": [
            "los angeles", "la", "burbank", "long beach",
            "ontario", "santa ana", "john wayne",
        ],
        "airports": ["LAX", "BUR", "LGB", "ONT", "SNA"],
    },
    "Chicago": {
        "aliases": ["chicago", "midway"],
        "airports": ["ORD", "MDW"],
    },
    "Washington DC": {
        "aliases": [
            "washington", "dc", "washington dc", "dulles",
            "baltimore", "reagan",
        ],
        "airports": ["DCA", "IAD", "BWI"],
    },
    "Dallas": {
        "aliases": ["dallas", "dfw", "fort worth", "love field"],
        "airports": ["DFW", "DAL"],
    },
    "Houston": {
        "aliases": ["houston", "hobby", "bush"],
        "airports": ["IAH", "HOU"],
    },
    "Miami": {
        "aliases": ["miami", "fort lauderdale"],
        "airports": ["MIA", "FLL"],
    },
    "Boston": {
        "aliases": ["boston"],
        "airports": ["BOS"],
    },
    "Seattle": {
        "aliases": ["seattle"],
        "airports": ["SEA"],
    },
    "Denver": {
        "aliases": ["denver"],
        "airports": ["DEN"],
    },
    "Atlanta": {
        "aliases": ["atlanta"],
        "airports": ["ATL"],
    },
    "Detroit": {
        "aliases": ["detroit"],
        "airports": ["DTW"],
    },
    "Minneapolis": {
        "aliases": ["minneapolis"],
        "airports": ["MSP"],
    },
    "Phoenix": {
        "aliases": ["phoenix"],
        "airports": ["PHX"],
    },
    "Philadelphia": {
        "aliases": ["philadelphia", "philly"],
        "airports": ["PHL"],
    },
    "Toronto": {
        "aliases": ["toronto", "pearson", "billy bishop"],
        "airports": ["YYZ", "YTZ"],
    },
    "Montreal": {
        "aliases": ["montreal", "trudeau"],
        "airports": ["YUL"],
    },
    "Vancouver": {
        "aliases": ["vancouver"],
        "airports": ["YVR"],
    },
    "London": {
        "aliases": [
            "london", "heathrow", "gatwick", "stansted",
            "luton", "city airport",
        ],
        "airports": ["LHR", "LGW", "STN", "LTN", "LCY"],
    },
    "Paris": {
        "aliases": ["paris", "orly", "charles de gaulle"],
        "airports": ["CDG", "ORY"],
    },
    "Berlin": {
        "aliases": ["berlin"],
        "airports": ["BER"],
    },
    "Frankfurt": {
        "aliases": ["frankfurt"],
        "airports": ["FRA"],
    },
    "Munich": {
        "aliases": ["munich"],
        "airports": ["MUC"],
    },
    "Amsterdam": {
        "aliases": ["amsterdam", "schiphol"],
        "airports": ["AMS"],
    },
    "Rome": {
        "aliases": ["rome", "roma", "fiumicino", "ciampino"],
        "airports": ["FCO", "CIA"],
    },
    "Milan": {
        "aliases": ["milan", "milano", "malpensa", "linate"],
        "airports": ["MXP", "LIN"],
    },
    "Madrid": {
        "aliases": ["madrid"],
        "airports": ["MAD"],
    },
    "Barcelona": {
        "aliases": ["barcelona"],
        "airports": ["BCN"],
    },
    "Lisbon": {
        "aliases": ["lisbon"],
        "airports": ["LIS"],
    },
    "Zurich": {
        "aliases": ["zurich"],
        "airports": ["ZRH"],
    },
    "Vienna": {
        "aliases": ["vienna"],
        "airports": ["VIE"],
    },
    "Dublin": {
        "aliases": ["dublin"],
        "airports": ["DUB"],
    },
    "Copenhagen": {
        "aliases": ["copenhagen"],
        "airports": ["CPH"],
    },
    "Stockholm": {
        "aliases": ["stockholm", "arlanda", "bromma"],
        "airports": ["ARN", "BMA"],
    },
    "Oslo": {
        "aliases": ["oslo"],
        "airports": ["OSL"],
    },
    "Istanbul": {
        "aliases": ["istanbul", "sabiha"],
        "airports": ["IST", "SAW"],
    },
    "Tokyo": {
        "aliases": ["tokyo", "narita", "haneda"],
        "airports": ["NRT", "HND"],
    },
    "Osaka": {
        "aliases": ["osaka"],
        "airports": ["KIX", "ITM"],
    },
    "Seoul": {
        "aliases": ["seoul", "incheon", "gimpo"],
        "airports": ["ICN", "GMP"],
    },
    "Beijing": {
        "aliases": ["beijing", "daxing"],
        "airports": ["PEK", "PKX"],
    },
    "Shanghai": {
        "aliases": ["shanghai", "pudong", "hongqiao"],
        "airports": ["PVG", "SHA"],
    },
    "Hong Kong": {
        "aliases": ["hong kong"],
        "airports": ["HKG"],
    },
    "Singapore": {
        "aliases": ["singapore"],
        "airports": ["SIN"],
    },
    "Bangkok": {
        "aliases": ["bangkok"],
        "airports": ["BKK", "DMK"],
    },
    "Taipei": {
        "aliases": ["taipei"],
        "airports": ["TPE"],
    },
    "Mumbai": {
        "aliases": ["mumbai", "bombay"],
        "airports": ["BOM"],
    },
    "Delhi": {
        "aliases": ["delhi", "new delhi"],
        "airports": ["DEL"],
    },
    "Dubai": {
        "aliases": ["dubai"],
        "airports": ["DXB", "DWC"],
    },
    "Tel Aviv": {
        "aliases": ["tel aviv"],
        "airports": ["TLV"],
    },
    "Sydney": {
        "aliases": ["sydney"],
        "airports": ["SYD"],
    },
    "Melbourne": {
        "aliases": ["melbourne"],
        "airports": ["MEL"],
    },
    "São Paulo": {
        "aliases": ["sao paulo", "são paulo", "guarulhos", "congonhas"],
        "airports": ["GRU", "CGH"],
    },
    "Buenos Aires": {
        "aliases": ["buenos aires"],
        "airports": ["EZE", "AEP"],
    },
    "Rio de Janeiro": {
        "aliases": ["rio", "rio de janeiro"],
        "airports": ["GIG", "SDU"],
    },
    "Mexico City": {
        "aliases": ["mexico city"],
        "airports": ["MEX"],
    },
    "Bogota": {
        "aliases": ["bogota"],
        "airports": ["BOG"],
    },
    "Lima": {
        "aliases": ["lima"],
        "airports": ["LIM"],
    },
    "Cairo": {
        "aliases": ["cairo"],
        "airports": ["CAI"],
    },
    "Johannesburg": {
        "aliases": ["johannesburg"],
        "airports": ["JNB"],
    },
    "Nairobi": {
        "aliases": ["nairobi"],
        "airports": ["NBO"],
    },
}

# Build lookups: city/alias → list of IATA codes (expands to metro)
# IATA codes resolve to themselves (exact airport), not the metro
_CITY_LOOKUP = {}
for _metro, _info in METRO_AREAS.items():
    codes = _info["airports"]
    _CITY_LOOKUP[_metro.lower()] = codes
    for alias in _info["aliases"]:
        _CITY_LOOKUP[alias.lower()] = codes

# Known IATA codes (for detecting "this is a code, not a city")
_KNOWN_IATA = set()
for _info in METRO_AREAS.values():
    for code in _info["airports"]:
        _KNOWN_IATA.add(code.upper())


def resolve_airports(code_or_city):
    """Resolve a city name or IATA code to a list of airport codes.

    Known IATA codes resolve to themselves — not the full metro area.
    City names and aliases expand to all airports in that metro.
    Unknown 3-letter codes are passed through as-is.
    """
    raw = code_or_city.strip()
    key = raw.lower()

    # Check city/alias lookup first (handles "NYC", "nyc", "London", etc.)
    if key in _CITY_LOOKUP:
        return _CITY_LOOKUP[key]

    # Then check if it's a known IATA code (exact airport, not metro)
    if raw.upper() in _KNOWN_IATA:
        return [raw.upper()]

    # Assume it's an unknown IATA code
    return [raw.upper()]


def parse_departure_hour(departure_str):
    """Parse hour from departure string like '6:00 PM on Sat, Mar 7'."""
    try:
        time_part = departure_str.split(" on ")[0].strip()
        hour_str, rest = time_part.split(":")
        hour = int(hour_str)
        if "PM" in rest.upper() and hour != 12:
            hour += 12
        elif "AM" in rest.upper() and hour == 12:
            hour = 0
        return hour
    except (ValueError, IndexError):
        return None


def search_flights(origin, destination, date, cabin, passengers, nonstop):
    """Search flights for a single origin→destination pair."""
    from fast_flights import FlightData, Passengers as Pax, get_flights

    seat_map = {
        "economy": "economy",
        "premium": "premium-economy",
        "business": "business",
        "first": "first",
    }

    kwargs = {}
    if nonstop:
        kwargs["max_stops"] = 0

    fd = FlightData(
        date=date,
        from_airport=origin,
        to_airport=destination,
        **kwargs,
    )

    try:
        result = get_flights(
            flight_data=[fd],
            trip="one-way",
            passengers=Pax(adults=passengers),
            seat=seat_map[cabin],
        )
        return result.flights or []
    except Exception as e:
        msg = str(e)
        if "No flights found" in msg or len(msg) > 500:
            return []
        raise


def main():
    parser = argparse.ArgumentParser(
        description="Search flights via Google Flights. Supports city names (NYC, London, Tokyo) and IATA codes.",
        epilog="Examples:\n"
        "  flights-search NYC LAX 2026-03-15\n"
        "  flights-search NYC Berlin 2026-03-15 --nonstop\n"
        "  flights-search London Tokyo 2026-04-01 --class business\n"
        "  flights-search JFK LHR 2026-03-15 --after 17 --before 22",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )
    parser.add_argument(
        "origin",
        help="Departure airport IATA code or city name (e.g., JFK, NYC, London)",
    )
    parser.add_argument(
        "destination",
        help="Arrival airport IATA code or city name (e.g., LAX, Tokyo, Berlin)",
    )
    parser.add_argument("date", help="Travel date (YYYY-MM-DD)")
    parser.add_argument(
        "--nonstop", action="store_true", help="Nonstop flights only"
    )
    parser.add_argument(
        "--all-stops",
        action="store_true",
        help="Show all flights regardless of stops (default: show fewest stops available)",
    )
    parser.add_argument(
        "--after", type=int, metavar="HH", help="Depart after hour (24h format)"
    )
    parser.add_argument(
        "--before", type=int, metavar="HH", help="Depart before hour (24h format)"
    )
    parser.add_argument(
        "--class",
        dest="cabin",
        default="economy",
        choices=["economy", "premium", "business", "first"],
        help="Cabin class (default: economy)",
    )
    parser.add_argument(
        "--passengers", type=int, default=1, help="Number of travelers (default: 1)"
    )
    parser.add_argument(
        "--link", action="store_true", help="Print Google Flights booking URL"
    )
    args = parser.parse_args()

    try:
        import fast_flights  # noqa: F401
    except ImportError:
        print(
            "Error: fast-flights not installed. Run: pip install fast-flights",
            file=sys.stderr,
        )
        sys.exit(1)

    origins = resolve_airports(args.origin)
    destinations = resolve_airports(args.destination)

    multi_origin = len(origins) > 1
    multi_dest = len(destinations) > 1

    if multi_origin:
        print(f"Searching from {args.origin}: {', '.join(origins)}")
    if multi_dest:
        print(f"Searching to {args.destination}: {', '.join(destinations)}")
    if multi_origin or multi_dest:
        print()

    all_flights = []

    for orig in origins:
        for dest in destinations:
            if orig == dest:
                continue
            try:
                flights = search_flights(
                    orig, dest, args.date, args.cabin, args.passengers, args.nonstop
                )
                for f in flights:
                    all_flights.append((orig, dest, f))
            except Exception as e:
                print(f"  {orig} → {dest}: Error - {e}", file=sys.stderr)

    if not all_flights:
        print("No flights found.")
        sys.exit(0)

    # Filter by departure time
    if args.after or args.before:
        filtered = []
        for orig, dest, f in all_flights:
            hour = parse_departure_hour(getattr(f, "departure", ""))
            if hour is None:
                filtered.append((orig, dest, f))
                continue
            if args.after and hour < args.after:
                continue
            if args.before and hour >= args.before:
                continue
            filtered.append((orig, dest, f))
        all_flights = filtered

    if not all_flights:
        print("No flights match the time filters.")
        sys.exit(0)

    # Find minimum stops unless --all-stops
    if not args.all_stops and not args.nonstop:
        stop_counts = []
        for _, _, f in all_flights:
            stops = getattr(f, "stops", None)
            if stops is not None:
                try:
                    stop_counts.append(int(stops) if str(stops).isdigit() else 0)
                except (ValueError, TypeError):
                    stop_counts.append(0)
            else:
                stop_counts.append(0)
        if stop_counts:
            min_stops = min(stop_counts)
            all_flights = [
                (o, d, f)
                for (o, d, f), s in zip(all_flights, stop_counts)
                if s == min_stops
            ]

    # Deduplicate (same departure + arrival + airline + price)
    seen = set()
    unique_flights = []
    for orig, dest, f in all_flights:
        key = (
            getattr(f, "departure", ""),
            getattr(f, "arrival", ""),
            getattr(f, "name", ""),
            getattr(f, "price", ""),
        )
        if key not in seen:
            seen.add(key)
            unique_flights.append((orig, dest, f))
    all_flights = unique_flights

    # Sort by departure time
    def sort_key(item):
        hour = parse_departure_hour(getattr(item[2], "departure", ""))
        return hour if hour is not None else 99

    all_flights.sort(key=sort_key)

    # Print results
    show_route = multi_origin or multi_dest
    if show_route:
        header = f"{'Route':<12} {'Depart':<28} {'Arrive':<28} {'Airline':<16} {'Price':<11} {'Duration'}"
    else:
        header = f"{'Depart':<28} {'Arrive':<28} {'Airline':<16} {'Price':<11} {'Duration'}"
    print(header)
    print("-" * len(header))

    for orig, dest, f in all_flights:
        dep = getattr(f, "departure", "?")
        arr = getattr(f, "arrival", "?")
        airline = getattr(f, "name", getattr(f, "airline", "?"))
        price = getattr(f, "price", "?")
        duration = getattr(f, "duration", "?")
        if show_route:
            route = f"{orig}→{dest}"
            print(f"{route:<12} {dep:<28} {arr:<28} {airline:<16} {price:<11} {duration}")
        else:
            print(f"{dep:<28} {arr:<28} {airline:<16} {price:<11} {duration}")

    print(f"\n{len(all_flights)} flight(s) found.")

    if args.link:
        # Google Flights search link for the overall query
        origin = origins[0]
        dest = destinations[0]
        print(
            f"\nGoogle Flights: https://www.google.com/travel/flights?"
            f"q=Flights+from+{origin}+to+{dest}+on+{args.date}"
        )

        # Per-flight booking links for unique airline+route combos
        seen_links = set()
        for orig, dst, f in all_flights:
            airline = getattr(f, "name", "").strip()
            if not airline:
                continue
            link = get_airline_booking_url(airline, orig, dst, args.date)
            if link and link not in seen_links:
                seen_links.add(link)
                print(f"  {airline} ({orig}→{dst}): {link}")


# Airline name → booking URL builder
# These are direct search URLs that pre-fill route/date on the airline's site
AIRLINE_BOOKING_URLS = {
    "united": lambda o, d, dt: (
        f"https://www.united.com/en/us/fsr/choose-flights?"
        f"f={o}&t={d}&d={dt}&tt=1&at=1&sc=7&px=1&taxng=1&newHP=True&clm=7&st=bestmatches"
    ),
    "delta": lambda o, d, dt: (
        f"https://www.delta.com/flight-search/search?"
        f"action=findFlights&tripType=ONE_WAY&departureDate={dt}"
        f"&returnDate=&paxCount=1&searchByCabin=true&cabinFareClass=BE"
        f"&originCity={o}&destinationCity={d}"
    ),
    "american": lambda o, d, dt: (
        f"https://www.aa.com/booking/search?"
        f"locale=en_US&pax=1&type=OneWay&searchType=Revenue"
        f"&cabin=&carriers=ALL&slices=%5B%7B%22orig%22%3A%22{o}%22"
        f"%2C%22dest%22%3A%22{d}%22%2C%22departDate%22%3A%22{dt}%22%7D%5D"
    ),
    "jetblue": lambda o, d, dt: (
        f"https://www.jetblue.com/booking/flights?"
        f"from={o}&to={d}&depart={dt}&is498RoundTrip=false&fareFamily=lowest"
    ),
    "southwest": lambda o, d, dt: (
        f"https://www.southwest.com/air/booking/select.html?"
        f"originationAirportCode={o}&destinationAirportCode={d}"
        f"&departureDate={dt}&returnDate=&tripType=oneway&passengerType=ADULT&numberOfAdults=1"
    ),
    "spirit": lambda o, d, dt: (
        f"https://www.spirit.com/book/flights?"
        f"orgCode={o}&desCode={d}&departDate={dt}&adults=1&returnDate=&tripType=oneWay"
    ),
    "frontier": lambda o, d, dt: (
        f"https://www.flyfrontier.com/booking/flights?"
        f"from={o}&to={d}&departDate={dt}&adults=1&tripType=oneway"
    ),
    "alaska": lambda o, d, dt: (
        f"https://www.alaskaair.com/shopping/flights?"
        f"A=1&prior=&ShoppingMethod=oneway"
        f"&prior=&prior=&prior=&prior=&prior=&prior=&prior=&prior=&prior="
        f"&prior=&FO={o}&FD={d}&OD={dt}"
    ),
    "air canada": lambda o, d, dt: (
        f"https://www.aircanada.com/booking/search?"
        f"tripType=O&org0={o}&dest0={d}&departDate0={dt}&ADT=1"
    ),
    "british airways": lambda o, d, dt: (
        f"https://www.britishairways.com/travel/book/public/en_us?"
        f"origin={o}&destination={d}&departDate={dt}&cabin=M&adultCount=1&tripType=oneWay"
    ),
    "lufthansa": lambda o, d, dt: (
        f"https://www.lufthansa.com/us/en/flight-search?"
        f"origin={o}&destination={d}&outDate={dt}&pax=1ADT&tripType=OW"
    ),
}


def get_airline_booking_url(airline_name, origin, dest, date):
    """Try to generate a direct airline booking URL."""
    name = airline_name.lower().strip()
    # Try exact match first, then prefix match
    for key, builder in AIRLINE_BOOKING_URLS.items():
        if key in name or name in key:
            try:
                return builder(origin, dest, date)
            except Exception:
                return None
    return None


if __name__ == "__main__":
    main()
