#!/usr/bin/env bash
#
# parallel-research - CLI wrapper for Parallel AI Task API (Deep Research)
#
# Usage:
#   parallel-research create "Research topic or question" [options]
#   parallel-research status <run_id>
#   parallel-research result <run_id>
#   parallel-research list
#
# Options for 'create':
#   -p, --processor PROCESSOR   Processor type (default: ultra)
#                               Standard: lite, base, core, core2x, pro, ultra, ultra2x, ultra4x, ultra8x
#                               Fast:     lite-fast, base-fast, core-fast, pro-fast, ultra-fast, etc.
#   -o, --output TYPE           Output type: auto (JSON) or text (markdown report) (default: text)
#   -w, --wait                  Wait for completion and show result
#   -j, --json                  Output raw JSON response
#
# Environment:
#   PARALLEL_API_KEY            Required. Your Parallel AI API key.
#
# Examples:
#   parallel-research create "Compare GPT-4 vs Claude 3.5 for code generation" --processor ultra-fast
#   parallel-research create "Market analysis of electric vehicles in 2024" -p pro -w
#   parallel-research status trun_abc123def456
#   parallel-research result trun_abc123def456

set -euo pipefail

# Load API key from secrets file if not already set
if [[ -z "${PARALLEL_API_KEY:-}" && -f "$HOME/.secrets/parallel_ai/.env" ]]; then
    export $(cat "$HOME/.secrets/parallel_ai/.env" | grep -v '^#' | xargs)
fi

API_BASE="https://api.parallel.ai/v1"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    head -40 "$0" | grep -E "^#" | sed 's/^# \?//'
    exit 0
}

error() {
    echo -e "${RED}Error:${NC} $1" >&2
    exit 1
}

info() {
    echo -e "${BLUE}→${NC} $1"
}

success() {
    echo -e "${GREEN}✓${NC} $1"
}

check_api_key() {
    if [[ -z "${PARALLEL_API_KEY:-}" ]]; then
        error "PARALLEL_API_KEY environment variable is not set.
Set it with: export PARALLEL_API_KEY=your_key_here"
    fi
}

# Create a new research task
cmd_create() {
    local input=""
    local processor="ultra"
    local output_type="text"
    local wait_for_result=false
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p|--processor)
                processor="$2"
                shift 2
                ;;
            -o|--output)
                output_type="$2"
                shift 2
                ;;
            -w|--wait)
                wait_for_result=true
                shift
                ;;
            -j|--json)
                json_output=true
                shift
                ;;
            -h|--help)
                usage
                ;;
            -*)
                error "Unknown option: $1"
                ;;
            *)
                if [[ -z "$input" ]]; then
                    input="$1"
                else
                    input="$input $1"
                fi
                shift
                ;;
        esac
    done
    
    if [[ -z "$input" ]]; then
        error "No research topic provided.
Usage: parallel-research create \"Your research question\" [options]"
    fi
    
    check_api_key
    
    # Build task_spec based on output type
    local task_spec
    if [[ "$output_type" == "text" ]]; then
        task_spec='{"output_schema": {"type": "text"}}'
    else
        # Auto schema - let the API decide structure
        task_spec='{}'
    fi
    
    # Escape the input for JSON
    local escaped_input
    escaped_input=$(echo -n "$input" | jq -Rs .)
    
    local payload
    payload=$(cat <<EOF
{
    "input": $escaped_input,
    "processor": "$processor",
    "task_spec": $task_spec
}
EOF
)
    
    info "Creating research task with processor: $processor"
    
    local response
    response=$(curl -s -X POST "${API_BASE}/tasks/runs" \
        -H "x-api-key: ${PARALLEL_API_KEY}" \
        -H "Content-Type: application/json" \
        -d "$payload")
    
    local run_id
    run_id=$(echo "$response" | jq -r '.run_id // empty')
    
    if [[ -z "$run_id" ]]; then
        local error_msg
        error_msg=$(echo "$response" | jq -r '.message // .error // "Unknown error"')
        error "Failed to create task: $error_msg"
    fi
    
    if [[ "$json_output" == true ]]; then
        echo "$response" | jq .
    else
        success "Task created!"
        echo ""
        echo "  Run ID:    $run_id"
        echo "  Processor: $processor"
        echo "  Platform:  https://platform.parallel.ai/view/task-run/$run_id"
        echo ""
        echo "Check status with: parallel-research status $run_id"
        echo "Get result with:   parallel-research result $run_id"
    fi
    
    if [[ "$wait_for_result" == true ]]; then
        echo ""
        info "Waiting for completion..."
        cmd_wait_and_result "$run_id" "$json_output"
    fi
}

# Get task status
cmd_status() {
    local run_id="$1"
    
    if [[ -z "$run_id" ]]; then
        error "No run_id provided.
Usage: parallel-research status <run_id>"
    fi
    
    check_api_key
    
    local response
    response=$(curl -s -X GET "${API_BASE}/tasks/runs/${run_id}" \
        -H "x-api-key: ${PARALLEL_API_KEY}")
    
    local status
    status=$(echo "$response" | jq -r '.status // empty')
    
    if [[ -z "$status" ]]; then
        local error_msg
        error_msg=$(echo "$response" | jq -r '.message // .error // "Unknown error"')
        error "Failed to get status: $error_msg"
    fi
    
    local created_at completed_at processor
    created_at=$(echo "$response" | jq -r '.created_at // "N/A"')
    completed_at=$(echo "$response" | jq -r '.completed_at // "N/A"')
    processor=$(echo "$response" | jq -r '.processor // "N/A"')
    
    case "$status" in
        pending|running)
            echo -e "${YELLOW}⏳${NC} Status: $status"
            ;;
        completed)
            echo -e "${GREEN}✓${NC} Status: $status"
            ;;
        failed)
            echo -e "${RED}✗${NC} Status: $status"
            local error_msg
            error_msg=$(echo "$response" | jq -r '.error // "Unknown error"')
            echo "   Error: $error_msg"
            ;;
        *)
            echo "Status: $status"
            ;;
    esac
    
    echo ""
    echo "  Run ID:     $run_id"
    echo "  Processor:  $processor"
    echo "  Created:    $created_at"
    [[ "$completed_at" != "null" && "$completed_at" != "N/A" ]] && echo "  Completed:  $completed_at"
    echo "  Platform:   https://platform.parallel.ai/view/task-run/$run_id"
}

# Get task result
cmd_result() {
    local run_id="$1"
    local json_output="${2:-false}"
    
    if [[ -z "$run_id" ]]; then
        error "No run_id provided.
Usage: parallel-research result <run_id>"
    fi
    
    check_api_key
    
    local response
    response=$(curl -s -X GET "${API_BASE}/tasks/runs/${run_id}/result" \
        -H "x-api-key: ${PARALLEL_API_KEY}")
    
    local status
    status=$(echo "$response" | jq -r '.status // empty')
    
    if [[ "$status" == "pending" || "$status" == "running" ]]; then
        echo -e "${YELLOW}⏳${NC} Task is still $status. Please wait and try again."
        exit 0
    fi
    
    if [[ "$status" == "failed" ]]; then
        local error_msg
        error_msg=$(echo "$response" | jq -r '.error // "Unknown error"')
        error "Task failed: $error_msg"
    fi
    
    if [[ "$json_output" == true ]]; then
        echo "$response" | jq .
    else
        # Try to extract content - could be text or structured
        local content
        content=$(echo "$response" | jq -r '.output.content // .output // empty')
        
        if [[ -n "$content" && "$content" != "null" ]]; then
            # Check if it's a string (markdown) or object (structured)
            local content_type
            content_type=$(echo "$response" | jq -r '.output.content | type')
            
            if [[ "$content_type" == "string" ]]; then
                echo "$content"
            else
                echo "$response" | jq '.output'
            fi
        else
            echo "$response" | jq .
        fi
    fi
}

# Wait for completion then get result
cmd_wait_and_result() {
    local run_id="$1"
    local json_output="${2:-false}"
    local poll_interval=10
    local max_wait=7200  # 2 hours
    local elapsed=0
    
    while [[ $elapsed -lt $max_wait ]]; do
        local response
        response=$(curl -s -X GET "${API_BASE}/tasks/runs/${run_id}" \
            -H "x-api-key: ${PARALLEL_API_KEY}")
        
        local status
        status=$(echo "$response" | jq -r '.status // empty')
        
        case "$status" in
            completed)
                success "Task completed!"
                echo ""
                cmd_result "$run_id" "$json_output"
                return 0
                ;;
            failed)
                local error_msg
                error_msg=$(echo "$response" | jq -r '.error // "Unknown error"')
                error "Task failed: $error_msg"
                ;;
            pending|running)
                echo -ne "\r${YELLOW}⏳${NC} Status: $status (${elapsed}s elapsed)..."
                sleep "$poll_interval"
                elapsed=$((elapsed + poll_interval))
                ;;
            *)
                error "Unknown status: $status"
                ;;
        esac
    done
    
    error "Timeout waiting for task completion after ${max_wait}s"
}

# List recent tasks (basic implementation)
cmd_list() {
    check_api_key
    
    # Note: The Parallel API may not have a direct list endpoint
    # This is a placeholder that shows how to check tracking files
    echo "Recent research tasks from tracking files:"
    echo ""
    
    local tracking_files
    tracking_files=$(find ~/repos/brain-dumps -name "research-tracking.json" 2>/dev/null | head -5)
    
    if [[ -z "$tracking_files" ]]; then
        echo "No research-tracking.json files found in ~/repos/brain-dumps/"
        echo ""
        echo "To track tasks, the execute-brain-dump-tasks skill saves task IDs to:"
        echo "  ~/repos/brain-dumps/<dump-folder>/research-tracking.json"
        return 0
    fi
    
    for file in $tracking_files; do
        echo "From: $file"
        jq -r '.research_tasks[] | "  \(.status | if . == "completed" then "✓" elif . == "pending" then "⏳" else "?" end) \(.task_id) - \(.title)"' "$file" 2>/dev/null || echo "  (Could not parse)"
        echo ""
    done
}

# Main
case "${1:-}" in
    create)
        shift
        cmd_create "$@"
        ;;
    status)
        shift
        cmd_status "${1:-}"
        ;;
    result)
        shift
        cmd_result "${1:-}" "${2:-false}"
        ;;
    list)
        cmd_list
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        error "Unknown command: $1
Run 'parallel-research --help' for usage."
        ;;
esac
